name: Natours CI/CD Pipeline

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  test:
    name: Test and Build
    # runs-on: ubuntu-latest
    runs-on: ${{ matrix.os }}
    environment: natours-api-app

    strategy:
      matrix:
        node-version: [24.x, 25.x]
        os: [ubuntu-latest] #Just added this for testing purposes, we can remove it later if we want to test only on ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run linting checks
        run: npm run lint --if-present || echo "No linting configured"

      - name: Run tests
        run: npm test

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: matrix.node-version == '25.x'
        with:
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Build application
        run: npm run build --if-present || echo "No build step configured"

      - name: Debug secrets
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')
        run: |
          echo "GitHub ref: $GITHUB_REF"
          echo "GitHub event: $GITHUB_EVENT_NAME"
          echo "Environment: $GITHUB_ENVIRONMENT"
          echo "Database password length: ${#DATABASE_PASSWORD}"
          echo "Username length: ${#DOCKER_USERNAME}"
          echo "Token length: ${#DOCKERHUB_TOKEN}"
          echo "Database password length: ${#DATABASE_PASSWORD}"
          echo "JWT secret length: ${#JWT_SECRET}"
          echo "Stripe secret key length: ${#STRIPE_SECRET_KEY}"
          echo "SendGrid username length: ${#SENDGRID_USERNAME}"
          echo "SendGrid password length: ${#SENDGRID_PASSWORD}"
          echo "Mailtrap username length: ${#MAILTRAP_USERNAME}"
          echo "Mailtrap password length: ${#MAILTRAP_PASSWORD}"
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to Docker Hub
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push Docker image
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')
        uses: mr-smithers-excellent/docker-build-push@v6
        with:
          image: gdakore/my-repo
          tags: v1,latest
          registry: docker.io
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker compose to test the application
        env:
          NODE_ENV: development
          DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
          DATABASE: ${{ secrets.DATABASE }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN: 30d
          JWT_COOKIE_EXPIRES_IN: 30
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          SENDGRID_USERNAME: ${{ secrets.SENDGRID_USERNAME }}
          SENDGRID_PASSWORD: ${{ secrets.SENDGRID_PASSWORD }}
          MAILTRAP_USERNAME: ${{ secrets.MAILTRAP_USERNAME }}
          MAILTRAP_PASSWORD: ${{ secrets.MAILTRAP_PASSWORD }}
          APP_PASSWORD: ${{ secrets.APP_PASSWORD }}
          PORT: 3000
          LOCAL_HOST_CLIENT: http://localhost:3000
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          MAILTRAP_HOST: ${{ secrets.MAILTRAP_HOST }}
          MAILTRAP_PORT: ${{ secrets.MAILTRAP_PORT }}
        run: |
          docker compose up -d
          echo "Waiting for app to start..."
          sleep 15

          # Check container logs
          echo "=== Container Logs ==="
          docker compose logs

          # Check if container is still running
          echo "=== Container Status ==="
          docker compose ps

          # Test different endpoints
          echo "=== Testing Root Endpoint ==="
          curl -v http://localhost:3000 || true

          echo "=== Testing Health Endpoint (if exists) ==="
          curl -v http://localhost:3000/api/v1/health || true

          # Check what's listening on port 3000 inside container
          echo "=== Processes inside container ==="
          docker exec natours-app ps aux || true

          echo "=== Network connections inside container ==="
          docker exec natours-app netstat -tln || true

          # Get all logs
          docker logs natours-app 2>&1 | head -50

          # Check if Node.js process is running
          docker exec natours-app ps aux | grep node

          docker compose down
          exit 1  # Fail the build since app isn't responding correctly

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "25.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check for security vulnerabilities
        run: npm audit --audit-level=moderate || true

      - name: Check for outdated packages
        run: npm outdated || true
